import 'dart:io';
import '../models/product_entry.dart';

// Simplified share service without share_plus dependency
// This provides mock sharing functionality until dependencies are resolved
class ShareService {
  /// ê¸°ë¡ëœ ë°ì´í„°ë¥¼ Excel íŒŒì¼ë¡œ ê³µìœ  (ëª¨ì¡° êµ¬í˜„)
  static Future<void> shareInventoryData(List<ProductEntry> entries) async {
    try {
      if (entries.isEmpty) {
        throw Exception('ê³µìœ í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }

      // ëª¨ì¡° êµ¬í˜„: ë¡œê·¸ë§Œ ì¶œë ¥
      print('íŒŒì¼ ê³µìœ  ëª¨ì¡° êµ¬í˜„: Excel íŒŒì¼ ê³µìœ ');
      print('ì œëª©: ì¬ê³  ì¡°ì‚¬ ê²°ê³¼ - ${DateTime.now().toLocal().toString().substring(0, 10)}');
      print('ë‚´ìš©: ì¬ê³  ì¡°ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤. (ì´ ${entries.length}ê°œ í•­ëª©)');
    } catch (e) {
      throw Exception('íŒŒì¼ ê³µìœ  ì‹¤íŒ¨: ${e.toString()}');
    }
  }

  /// ë‹¨ìˆœ í…ìŠ¤íŠ¸ë¡œ ê³µìœ  (ëª¨ì¡° êµ¬í˜„)
  static Future<void> shareAsText(List<ProductEntry> entries) async {
    try {
      if (entries.isEmpty) {
        throw Exception('ê³µìœ í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }

      final StringBuffer buffer = StringBuffer();
      buffer.writeln('ì¬ê³  ì¡°ì‚¬ ê²°ê³¼');
      buffer.writeln('ë‚ ì§œ: ${DateTime.now().toLocal().toString().substring(0, 10)}');
      buffer.writeln('ì´ í•­ëª©: ${entries.length}ê°œ');
      buffer.writeln('');

      for (int i = 0; i < entries.length; i++) {
        final entry = entries[i];
        buffer.writeln('${i + 1}. ${entry.productName}');
        buffer.writeln('   ë°”ì½”ë“œ: ${entry.barcode}');
        buffer.writeln('   ìˆ˜ëŸ‰: ${entry.quantity ?? 0}');
        if (entry.recordedAt != null) {
          buffer.writeln('   ê¸°ë¡ì‹œê°„: ${entry.recordedAt!.toLocal().toString().substring(0, 19)}');
        }
        buffer.writeln('');
      }

      // ëª¨ì¡° êµ¬í˜„: ë¡œê·¸ë§Œ ì¶œë ¥
      print('í…ìŠ¤íŠ¸ ê³µìœ  ëª¨ì¡° êµ¬í˜„:');
      print('ì œëª©: ì¬ê³  ì¡°ì‚¬ ê²°ê³¼ - ${DateTime.now().toLocal().toString().substring(0, 10)}');
      print('ë‚´ìš©:\n${buffer.toString()}');
    } catch (e) {
      throw Exception('í…ìŠ¤íŠ¸ ê³µìœ  ì‹¤íŒ¨: ${e.toString()}');
    }
  }

  /// CSV í˜•ì‹ìœ¼ë¡œ ê³µìœ  (ëª¨ì¡° êµ¬í˜„)
  static Future<void> shareAsCSV(List<ProductEntry> entries) async {
    try {
      if (entries.isEmpty) {
        throw Exception('ê³µìœ í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }

      final StringBuffer csvBuffer = StringBuffer();

      // CSV í—¤ë”
      csvBuffer.writeln('ë‚ ì§œ,ìƒí’ˆëª…,ë°”ì½”ë“œ,ìˆ˜ëŸ‰');

      // CSV ë°ì´í„°
      for (final entry in entries) {
        final date = entry.recordedAt?.toLocal().toString().substring(0, 19) ?? '';
        csvBuffer.writeln('$date,"${entry.productName}","${entry.barcode}",${entry.quantity ?? 0}');
      }

      // ëª¨ì¡° êµ¬í˜„: ë¡œê·¸ë§Œ ì¶œë ¥
      print('CSV ê³µìœ  ëª¨ì¡° êµ¬í˜„:');
      print('ì œëª©: ì¬ê³  ì¡°ì‚¬ ê²°ê³¼ (CSV) - ${DateTime.now().toLocal().toString().substring(0, 10)}');
      print('CSV ë°ì´í„°:\n${csvBuffer.toString()}');
    } catch (e) {
      throw Exception('CSV ê³µìœ  ì‹¤íŒ¨: ${e.toString()}');
    }
  }

  /// ìš”ì•½ ì •ë³´ ê³µìœ  (ëª¨ì¡° êµ¬í˜„)
  static Future<void> shareSummary(List<ProductEntry> entries) async {
    try {
      final totalItems = entries.length;
      final recordedItems = entries.where((e) => e.quantity != null).length;
      final totalQuantity = entries
          .where((e) => e.quantity != null)
          .map((e) => e.quantity!)
          .fold(0, (sum, qty) => sum + qty);

      final summary = '''
ì¬ê³  ì¡°ì‚¬ ìš”ì•½

ğŸ“… ì¡°ì‚¬ ë‚ ì§œ: ${DateTime.now().toLocal().toString().substring(0, 10)}

ğŸ“Š ì¡°ì‚¬ ê²°ê³¼:
â€¢ ì´ ìƒí’ˆ í•­ëª©: $totalItemsê°œ
â€¢ ê¸°ë¡ ì™„ë£Œ: $recordedItemsê°œ
â€¢ ì´ ìˆ˜ëŸ‰: $totalQuantityê°œ

ğŸ“ˆ ì™„ë£Œìœ¨: ${totalItems > 0 ? (recordedItems / totalItems * 100).toStringAsFixed(1) : '0.0'}%

ğŸ·ï¸ ì£¼ìš” ìƒí’ˆ:
${_getTopItems(entries)}

Generated by CigarCounter App
''';

      // ëª¨ì¡° êµ¬í˜„: ë¡œê·¸ë§Œ ì¶œë ¥
      print('ìš”ì•½ ê³µìœ  ëª¨ì¡° êµ¬í˜„:');
      print(summary);
    } catch (e) {
      throw Exception('ìš”ì•½ ê³µìœ  ì‹¤íŒ¨: ${e.toString()}');
    }
  }

  /// ìƒìœ„ 5ê°œ ìƒí’ˆ ì •ë³´ ìƒì„±
  static String _getTopItems(List<ProductEntry> entries) {
    final recordedEntries = entries.where((e) => e.quantity != null).toList();

    if (recordedEntries.isEmpty) {
      return 'â€¢ ê¸°ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    // ìˆ˜ëŸ‰ ê¸°ì¤€ ì •ë ¬
    recordedEntries.sort((a, b) => (b.quantity ?? 0).compareTo(a.quantity ?? 0));

    final topItems = recordedEntries.take(5).toList();
    final StringBuffer buffer = StringBuffer();

    for (int i = 0; i < topItems.length; i++) {
      final entry = topItems[i];
      buffer.writeln('â€¢ ${entry.productName}: ${entry.quantity}ê°œ');
    }

    if (recordedEntries.length > 5) {
      buffer.writeln('â€¢ ... ì™¸ ${recordedEntries.length - 5}ê°œ ìƒí’ˆ');
    }

    return buffer.toString().trim();
  }

  /// ê³µìœ  ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (ëª¨ì¡° êµ¬í˜„)
  static Future<bool> canShare() async {
    try {
      // ëª¨ì¡° êµ¬í˜„: í•­ìƒ true ë°˜í™˜
      return true;
    } catch (e) {
      return false;
    }
  }

  /// ì•±ì—ì„œ íŒŒì¼ ì—´ê¸° (ëª¨ì¡° êµ¬í˜„)
  static Future<void> openFile(File file) async {
    try {
      // ëª¨ì¡° êµ¬í˜„: ë¡œê·¸ë§Œ ì¶œë ¥
      print('íŒŒì¼ ì—´ê¸° ëª¨ì¡° êµ¬í˜„: ${file.path}');
    } catch (e) {
      throw Exception('íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: ${e.toString()}');
    }
  }
}